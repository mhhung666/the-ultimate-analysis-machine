#!/usr/bin/env bash
###############################################################################
# Market Intelligence System - Daily Analysis V3
#
# åŠŸèƒ½èªªæ˜:
#   ç”Ÿæˆä¸‰é¡ç¨ç«‹çš„åˆ†æå ±å‘Š,åˆ†æé †åºç¶“éå„ªåŒ–ä»¥æä¾›æœ€å…¨é¢çš„æ´å¯Ÿ
#
# åˆ†ææµç¨‹:
#   Step 1: å¸‚å ´åˆ†æ (market-analysis-{date}-{time}.md)
#           â†’ äº†è§£å…¨çƒå¸‚å ´ç’°å¢ƒã€è¶¨å‹¢ã€é‡è¦æ–°è
#
#   Step 2: å€‹è‚¡åˆ†æ (stock-{symbol}-{date}-{time}.md)
#           â†’ åŸºæ–¼å¸‚å ´ç’°å¢ƒ,æ·±å…¥åˆ†æå€‹åˆ¥è‚¡ç¥¨(è‡ªå‹•è·³éæŒ‡æ•¸)
#           â†’ æ¨™è¨»æ–°èä¾†æºã€è©•ä¼°å½±éŸ¿ã€æä¾›æ“ä½œå»ºè­°
#
#   Step 3: æŒå€‰åˆ†æ (holdings-analysis-{date}-{time}.md)
#           â†’ ç¶œåˆå¸‚å ´å’Œå€‹è‚¡åˆ†æ,è©•ä¼°æŠ•è³‡çµ„åˆ
#           â†’ èšç„¦:æŒè‚¡ç‹€æ³ã€é¸æ“‡æ¬Šç®¡ç†ã€ç¸¾æ•ˆè¿½è¹¤
#
# ä¾è³´:
#   - claude CLI: npm install -g @anthropic-ai/claude-cli
#   - å¿…é ˆå…ˆç™»å…¥: claude login
#
# ä½¿ç”¨æ–¹å¼:
#   ./scripts/analysis/run_daily_analysis_claude_cli.sh
#   TIME_SUFFIX=0800 ./scripts/analysis/run_daily_analysis_claude_cli.sh
#
# ç‰ˆæœ¬: v3.0
###############################################################################

set -e  # é‡åˆ°éŒ¯èª¤ç«‹å³é€€å‡º

###############################################################################
# ç’°å¢ƒè®Šæ•¸è¨­å®š
###############################################################################

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥æœŸå’Œæ™‚é–“
TODAY=$(date +"%Y-%m-%d")
YEAR=$(date +"%Y")

# æ™‚é–“å¾Œç¶´ (å¯é¸)
# æœªè¨­å®šæ™‚ä½¿ç”¨ç•¶å‰æ™‚é–“ (æ ¼å¼: HHMM, ä¾‹å¦‚ 0800, 1430, 2000)
if [ -z "$TIME_SUFFIX" ]; then
    TIME_SUFFIX=$(date +"%H%M")
fi

# è·¯å¾‘å®šç¾©
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
REPO_ROOT="$(cd "${PROJECT_ROOT}/../.." && pwd)"
OUTPUT_DIR="${PROJECT_ROOT}/output/market-data/${YEAR}"
DAILY_DIR="${OUTPUT_DIR}/Daily"
NEWS_DIR="${OUTPUT_DIR}/News"
REPORTS_DIR="${PROJECT_ROOT}/reports/markdown"
CONFIG_DIR="${REPO_ROOT}/config"

# è¼¸å…¥æª”æ¡ˆ
GLOBAL_INDICES="${DAILY_DIR}/global-indices-${TODAY}.md"
PRICES="${DAILY_DIR}/holdings-prices-${TODAY}.md"
HOLDINGS_CONFIG="${CONFIG_DIR}/holdings.yaml"
PORTFOLIO_SUMMARY="${CONFIG_DIR}/portfolio_summary.yaml"
PORTFOLIO_HOLDINGS="${REPO_ROOT}/src/financial-analysis-system/portfolio/${YEAR}/holdings.md"

# è¼¸å‡ºæª”æ¡ˆ
MARKET_ANALYSIS_OUTPUT="${REPORTS_DIR}/market-analysis-${TODAY}-${TIME_SUFFIX}.md"
HOLDINGS_ANALYSIS_OUTPUT="${REPORTS_DIR}/holdings-analysis-${TODAY}-${TIME_SUFFIX}.md"

# è‡¨æ™‚æª”æ¡ˆ
MARKET_PROMPT_FILE="/tmp/market-analysis-prompt-${TODAY}-${TIME_SUFFIX}.txt"
HOLDINGS_PROMPT_FILE="/tmp/holdings-analysis-prompt-${TODAY}-${TIME_SUFFIX}.txt"

###############################################################################
# å·¥å…·å‡½æ•¸
###############################################################################

# é¡¯ç¤ºç¨‹å¼é–‹é ­è³‡è¨Š
print_header() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BLUE}ğŸ“Š Market Intelligence System - æ¯æ—¥å¤šå ±å‘Šåˆ†æ v3.0${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    echo -e "${GREEN}ğŸ“… åˆ†ææ—¥æœŸ: ${TODAY}${NC}"
    echo -e "${GREEN}â° æ™‚é–“æ¨™è¨˜: ${TIME_SUFFIX}${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ“‹ åˆ†ææµç¨‹:${NC}"
    echo -e "${GREEN}  Step 1: å¸‚å ´åˆ†æ â†’ äº†è§£å…¨çƒå¸‚å ´ç’°å¢ƒ${NC}"
    echo -e "${GREEN}  Step 2: å€‹è‚¡åˆ†æ â†’ æ·±å…¥åˆ†æå€‹åˆ¥è‚¡ç¥¨${NC}"
    echo -e "${GREEN}  Step 3: æŒå€‰åˆ†æ â†’ è©•ä¼°æŠ•è³‡çµ„åˆè¡¨ç¾${NC}"
    echo ""
}

# æª¢æŸ¥ç³»çµ±ä¾è³´
check_dependencies() {
    echo -e "${BLUE}ğŸ” æª¢æŸ¥ç³»çµ±ä¾è³´...${NC}"

    # æª¢æŸ¥ claude CLI
    CLAUDE_BIN=""
    if command -v claude &> /dev/null; then
        CLAUDE_BIN="claude"
    elif [[ -x "${HOME}/.local/bin/claude" ]]; then
        CLAUDE_BIN="${HOME}/.local/bin/claude"
    elif [[ -x "/usr/local/bin/claude" ]]; then
        CLAUDE_BIN="/usr/local/bin/claude"
    else
        echo -e "${RED}âŒ éŒ¯èª¤: æœªå®‰è£ claude CLI${NC}"
        echo -e "${YELLOW}   å®‰è£æ–¹å¼: npm install -g @anthropic-ai/claude-cli${NC}"
        echo -e "${YELLOW}   ç™»å…¥æ–¹å¼: claude login${NC}"
        exit 1
    fi

    echo -e "${GREEN}   âœ… Claude CLI å·²å®‰è£ (${CLAUDE_BIN})${NC}"
    echo ""
}

# æª¢æŸ¥è³‡æ–™æª”æ¡ˆå®Œæ•´æ€§
check_data_files() {
    echo -e "${BLUE}ğŸ” æª¢æŸ¥è³‡æ–™æª”æ¡ˆ...${NC}"

    local missing_files=()

    if [[ ! -f "${GLOBAL_INDICES}" ]]; then
        missing_files+=("å…¨çƒæŒ‡æ•¸: ${GLOBAL_INDICES}")
    fi

    if [[ ! -f "${PRICES}" ]]; then
        missing_files+=("æŒå€‰åƒ¹æ ¼: ${PRICES}")
    fi

    if [[ ${#missing_files[@]} -gt 0 ]]; then
        echo -e "${YELLOW}âš ï¸  è­¦å‘Š: ä»¥ä¸‹è³‡æ–™æª”æ¡ˆä¸å­˜åœ¨:${NC}"
        for file in "${missing_files[@]}"; do
            echo -e "${YELLOW}     - ${file}${NC}"
        done
        echo ""
        echo -e "${YELLOW}   è«‹å…ˆåŸ·è¡Œ: make fetch-all${NC}"
        exit 1
    fi

    echo -e "${GREEN}   âœ… è³‡æ–™æª”æ¡ˆå®Œæ•´${NC}"
    echo ""
}

# æ”¶é›†ä»Šæ—¥æ–°èæª”æ¡ˆ
collect_news_files() {
    local news_files=($(find "${NEWS_DIR}" -name "*-${TODAY}.md" 2>/dev/null || true))
    printf '%s\n' "${news_files[@]}"
}

# å¾ holdings.yaml ä¸­æå–å•Ÿç”¨çš„è‚¡ç¥¨ä»£ç¢¼
get_enabled_holdings() {
    if [[ ! -f "${HOLDINGS_CONFIG}" ]]; then
        echo "" >&2
        return 1
    fi

    # æå–æ‰€æœ‰ symbol ä¸” enabled: true å’Œ fetch_news: true çš„è‚¡ç¥¨
    # ç­–ç•¥ï¼šé‡åˆ° symbol æ™‚è¨˜éŒ„ï¼Œé‡åˆ°è‚¡ç¥¨åç¨±è¡Œæ™‚æª¢æŸ¥ä¸¦è¼¸å‡º
    awk '
        # é‡åˆ°è‚¡ç¥¨åç¨±è¡Œï¼ˆ4å€‹ç©ºæ ¼ç¸®æ’ï¼Œä»¥å†’è™Ÿçµå°¾ï¼‰
        /^    [^ ].*:$/ {
            # å¦‚æœä¸Šä¸€å€‹è‚¡ç¥¨ç¬¦åˆæ¢ä»¶ï¼Œè¼¸å‡º
            if (symbol && fetch_news && enabled) {
                print symbol
            }
            # é‡ç½®è®Šæ•¸
            symbol=""; fetch_news=0; enabled=0
        }
        # é‡åˆ° symbol è¡Œ
        /symbol:/ {
            gsub(/"/, "", $2);
            symbol=$2
        }
        # é‡åˆ° fetch_news: true
        /fetch_news: true/ {
            fetch_news=1
        }
        # é‡åˆ° enabled: true
        /enabled: true/ {
            enabled=1
        }
        # æ–‡ä»¶çµå°¾è™•ç†æœ€å¾Œä¸€å€‹è‚¡ç¥¨
        END {
            if (symbol && fetch_news && enabled) {
                print symbol
            }
        }
    ' "${HOLDINGS_CONFIG}" | sort -u
}

# æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
cleanup() {
    rm -f "${MARKET_PROMPT_FILE}" "${HOLDINGS_PROMPT_FILE}"
}

###############################################################################
# Step 2: å€‹è‚¡åˆ†æå ±å‘Šç”Ÿæˆ
###############################################################################

# æª¢æŸ¥æ–°èæ˜¯å¦ç‚ºè¿‘æœŸ (ä»Šå¤©æˆ–æ˜¨å¤©)
check_recent_news() {
    local news_file="$1"

    # ç²å–ä»Šå¤©å’Œæ˜¨å¤©çš„æ—¥æœŸ (æ ¼å¼: Dec 09)
    # ä½¿ç”¨ LC_ALL=C å¼·åˆ¶è‹±æ–‡æœˆä»½æ ¼å¼,é¿å…èªè¨€ç’°å¢ƒå·®ç•°
    local today=$(LC_ALL=C date +"%b %d")
    local yesterday=$(LC_ALL=C date -d "1 day ago" +"%b %d" 2>/dev/null || LC_ALL=C date -v-1d +"%b %d" 2>/dev/null)

    # æª¢æŸ¥æ–°èæª”æ¡ˆä¸­æ˜¯å¦æœ‰è¿‘æœŸæ–°è (ç™¼å¸ƒæ™‚é–“åœ¨ä»Šå¤©æˆ–æ˜¨å¤©)
    if grep -E "ç™¼å¸ƒæ™‚é–“.*(${today}|${yesterday})" "${news_file}" > /dev/null 2>&1; then
        return 0  # æœ‰è¿‘æœŸæ–°è
    else
        return 1  # æ²’æœ‰è¿‘æœŸæ–°è
    fi
}

# ç”Ÿæˆå€‹è‚¡åˆ†ææª”æ¡ˆ
generate_stock_analysis_files() {
    echo -e "${BLUE}ğŸ“Š ç”Ÿæˆå€‹è‚¡åˆ†ææª”æ¡ˆ...${NC}"
    echo -e "${YELLOW}   (åƒ…åˆ†æ holdings.yaml ä¸­å•Ÿç”¨ä¸”æœ‰ä»Šå¤©æˆ–æ˜¨å¤©æ–°èçš„æŒè‚¡)${NC}"
    echo ""

    # ç²å–å•Ÿç”¨çš„æŒè‚¡åˆ—è¡¨
    local enabled_holdings
    enabled_holdings=()
    while IFS= read -r symbol; do
        [[ -n "$symbol" ]] && enabled_holdings+=("$symbol")
    done < <(get_enabled_holdings)

    if [[ ${#enabled_holdings[@]} -eq 0 ]]; then
        echo -e "${YELLOW}   âš ï¸  è­¦å‘Š: holdings.yaml ä¸­æ²’æœ‰å•Ÿç”¨çš„æŒè‚¡${NC}"
        echo ""
        return
    fi

    echo -e "${GREEN}   ğŸ“‹ æŒè‚¡æ¸…å–®: ${enabled_holdings[@]}${NC}"
    echo ""

    local count=0
    local skipped_no_news=0
    local skipped_old_news=0
    local skipped_not_holding=0

    # éæ­·å•Ÿç”¨çš„æŒè‚¡
    for symbol in "${enabled_holdings[@]}"; do
        local news_file="${NEWS_DIR}/${symbol}-${TODAY}.md"

        # æª¢æŸ¥æ–°èæª”æ¡ˆæ˜¯å¦å­˜åœ¨
        if [[ ! -f "${news_file}" ]]; then
            echo -e "${YELLOW}   â­ï¸  è·³é ${symbol} (ç„¡æ–°èæª”æ¡ˆ)${NC}"
            skipped_no_news=$((skipped_no_news + 1))
            continue
        fi

        # æª¢æŸ¥æ˜¯å¦æœ‰è¿‘æœŸæ–°è
        if ! check_recent_news "${news_file}"; then
            echo -e "${YELLOW}   â­ï¸  è·³é ${symbol} (ç„¡ä»Šå¤©æˆ–æ˜¨å¤©çš„æ–°è)${NC}"
            skipped_old_news=$((skipped_old_news + 1))
            continue
        fi

        local stock_analysis_file="${REPORTS_DIR}/stock-${symbol}-${TODAY}-${TIME_SUFFIX}.md"
        local stock_prompt_file="/tmp/stock-${symbol}-prompt-${TODAY}-${TIME_SUFFIX}.txt"

        # è®€å–æ–°èå…§å®¹
        local news_content
        news_content=$(<"${news_file}")

        # è®€å–æŒå€‰åƒ¹æ ¼è³‡è¨Š
        local price_info=""
        if [[ -f "${PRICES}" ]] && grep -q "${symbol}" "${PRICES}" 2>/dev/null; then
            price_info=$(grep -A 10 "## ${symbol}" "${PRICES}" 2>/dev/null || echo "")
        fi

        # ç”Ÿæˆå€‹è‚¡åˆ†æ prompt
        cat > "${stock_prompt_file}" <<EOF
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å€‹è‚¡åˆ†æå¸«,æ“…é•·åˆ†æå€‹åˆ¥è‚¡ç¥¨çš„æ–°èã€åƒ¹æ ¼èµ°å‹¢å’ŒæŠ•è³‡åƒ¹å€¼ã€‚

## ğŸ“‹ åˆ†æä»»å‹™

è«‹é‡å° **${symbol}** é€™æª”è‚¡ç¥¨,åŸºæ–¼**ä»Šå¤©æˆ–æ˜¨å¤©çš„æ–°è**å’Œåƒ¹æ ¼è³‡è¨Š,ç”Ÿæˆä¸€ä»½**å€‹è‚¡åˆ†æå ±å‘Š**ã€‚

### æ ¸å¿ƒè¦æ±‚:
1. **æ–°èæ‘˜è¦**: ç¸½çµé‡è¦æ–°è,ä¸¦æ¨™è¨»æ–°èä¾†æºå’Œç™¼å¸ƒæ™‚é–“
2. **å½±éŸ¿åˆ†æ**: è©•ä¼°æ–°èå°è‚¡åƒ¹çš„æ½›åœ¨å½±éŸ¿ (æ­£é¢/è² é¢/ä¸­æ€§)
3. **åƒ¹æ ¼èµ°å‹¢**: åˆ†æç•¶å‰åƒ¹æ ¼è¡¨ç¾(æ”¶ç›¤åƒ¹ã€æ¼²è·Œå¹…)

### é‡è¦æç¤º:
- **åƒ…é—œæ³¨ä»Šå¤©æˆ–æ˜¨å¤©çš„æ–°è**,èˆŠæ–°èå¯ä»¥å¿½ç•¥
- é‡é»åˆ†ææœ€æ–°ç™¼å±•å°è‚¡åƒ¹çš„å½±éŸ¿
- å®¢è§€åˆ†æ,ä¸éœ€è¦æä¾›æŠ•è³‡å»ºè­°

### å ±å‘Šé¢¨æ ¼:
- ç°¡æ½”æ˜ç­,é‡é»çªå‡º
- å®¢è§€æè¿°æ–°èå’Œåƒ¹æ ¼è®ŠåŒ–

---

## ğŸ“Š ${symbol} ä»Šæ—¥è³‡æ–™

### è‚¡ç¥¨æ–°è
\`\`\`markdown
${news_content}
\`\`\`

$(if [[ -n "${price_info}" ]]; then
echo "### åƒ¹æ ¼è³‡è¨Š
\`\`\`markdown
${price_info}
\`\`\`"
fi)

---

## ğŸ“„ å ±å‘Šçµæ§‹

è«‹æŒ‰ç…§ä»¥ä¸‹çµæ§‹ç”Ÿæˆå ±å‘Š:

# ğŸ“Š ${symbol} å€‹è‚¡åˆ†æ - ${TODAY}

> **å ±å‘Šç”Ÿæˆæ™‚é–“**: $(date +"%Y-%m-%d %H:%M UTC")
> **åˆ†æå¼•æ“**: Market Intelligence System v2.1
> **è‚¡ç¥¨ä»£ç¢¼**: ${symbol}

---

## ğŸ“° æ–°èæ‘˜è¦

### ä»Šæ—¥é‡é»æ–°è

[é‡å°æ¯å‰‡é‡è¦æ–°è,æŒ‰ä»¥ä¸‹æ ¼å¼å‘ˆç¾:]

#### ğŸ“Œ æ–°èæ¨™é¡Œ
- **ä¾†æº**: [æ–°èä¾†æº]
- **ç™¼å¸ƒæ™‚é–“**: [æ™‚é–“]
- **å½±éŸ¿è©•ä¼°**: ğŸŸ¢ æ­£é¢ / ğŸŸ¡ ä¸­æ€§ / ğŸ”´ è² é¢
- **æ‘˜è¦**: [ç°¡è¿°æ–°èå…§å®¹]
- **é—œéµè¦é»**:
  - è¦é»1
  - è¦é»2

[é‡è¤‡ä»¥ä¸Šæ ¼å¼åˆ†æå…¶ä»–æ–°è]

---

## ğŸ“ˆ ç¶œåˆå½±éŸ¿åˆ†æ

### æ–°èé¢å½±éŸ¿

**æ•´é«”æƒ…ç·’**: ğŸŸ¢ æ­£é¢ / ğŸŸ¡ ä¸­æ€§ / ğŸ”´ è² é¢

**é—œéµé©…å‹•å› ç´ **:
1. [å› ç´ 1]: ç°¡è¦èªªæ˜
2. [å› ç´ 2]: ç°¡è¦èªªæ˜

$(if [[ -n "${price_info}" ]]; then
echo "### åƒ¹æ ¼é¢åˆ†æ

**ç•¶å‰è¡¨ç¾**:
- æ”¶ç›¤åƒ¹: \\\$XX.XX
- æ¼²è·Œå¹…: Â±X.XX%

**åƒ¹æ ¼èˆ‡æ–°èé—œè¯**:
[åˆ†æåƒ¹æ ¼èµ°å‹¢æ˜¯å¦åæ˜ æ–°èé¢çš„è®ŠåŒ–]"
fi)

---

**åˆ†æå¼•æ“**: Claude (Sonnet 4.5)
**å ±å‘Šç‰ˆæœ¬**: v2.1

---

è«‹ç›´æ¥é–‹å§‹ç”Ÿæˆå®Œæ•´çš„å€‹è‚¡åˆ†æå ±å‘Š,å¾æ¨™é¡Œé–‹å§‹,ä¸è¦æœ‰ä»»ä½•å‰ç½®èªªæ˜æˆ–è©¢å•ã€‚
EOF

        # èª¿ç”¨ Claude ç”Ÿæˆå€‹è‚¡åˆ†æ
        echo -e "${YELLOW}   â³ åˆ†æ ${symbol}...${NC}"
        if cat "${stock_prompt_file}" | "${CLAUDE_BIN}" > "${stock_analysis_file}" 2>&1; then
            echo -e "${GREEN}   âœ… ${symbol} åˆ†æå®Œæˆ${NC}"
            count=$((count + 1))
        else
            echo -e "${RED}   âŒ ${symbol} åˆ†æå¤±æ•—${NC}"
        fi

        # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
        rm -f "${stock_prompt_file}"
    done

    echo ""
    echo -e "${GREEN}   âœ… å€‹è‚¡åˆ†æå®Œæˆ!${NC}"
    echo -e "${GREEN}      ç”Ÿæˆ: ${count} æª”${NC}"

    local total_skipped=$((skipped_no_news + skipped_old_news))
    if [[ ${total_skipped} -gt 0 ]]; then
        echo -e "${YELLOW}      è·³é: ${total_skipped} æª”${NC}"
        if [[ ${skipped_no_news} -gt 0 ]]; then
            echo -e "${YELLOW}        - ç„¡æ–°èæª”æ¡ˆ: ${skipped_no_news} æª”${NC}"
        fi
        if [[ ${skipped_old_news} -gt 0 ]]; then
            echo -e "${YELLOW}        - ç„¡è¿‘æœŸæ–°è: ${skipped_old_news} æª”${NC}"
        fi
    fi
    echo ""
}

###############################################################################
# Step 1: å¸‚å ´åˆ†æå ±å‘Šç”Ÿæˆ
###############################################################################

# ç”Ÿæˆå¸‚å ´åˆ†æ Prompt
generate_market_analysis_prompt() {
    echo -e "${BLUE}ğŸ“ ç”Ÿæˆå¸‚å ´åˆ†æ Prompt...${NC}"

    # è®€å–å…¨çƒæŒ‡æ•¸æ•¸æ“š
    local indices_data
    indices_data=$(<"${GLOBAL_INDICES}")

    # æ”¶é›†æ‰€æœ‰æ–°èä¸¦æ•´åˆ
    local news_data=""
    local news_files
    news_files=()
    while IFS= read -r line; do
        news_files+=("$line")
    done < <(collect_news_files)

    for news_file in "${news_files[@]}"; do
        if [[ -f "${news_file}" ]]; then
            local symbol
            symbol=$(basename "${news_file}" | sed "s/-${TODAY}.md//")
            local news_content
            news_content=$(<"${news_file}")
            news_data="${news_data}

### ${symbol} æ–°è
${news_content}"
        fi
    done

    local news_count=${#news_files[@]}

    # ç”Ÿæˆå¸‚å ´åˆ†æ Prompt
    cat > "${MARKET_PROMPT_FILE}" <<'EOF'
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å…¨çƒå¸‚å ´åˆ†æå¸«,æ“…é•·è§£è®€å¸‚å ´æ•¸æ“šå’Œæ–°è,æä¾›æ·±åº¦å¸‚å ´æ´å¯Ÿã€‚

## ğŸ“‹ åˆ†æä»»å‹™

è«‹æ ¹æ“šä»¥ä¸‹ä»Šæ—¥å¸‚å ´æ•¸æ“š,ç”Ÿæˆä¸€ä»½**å…¨çƒå¸‚å ´æƒ…å ±åˆ†æå ±å‘Š**ã€‚

### æ ¸å¿ƒè¦æ±‚:
1. **å¸‚å ´è¶¨å‹¢åˆ†æ**: è­˜åˆ¥å…¨çƒå¸‚å ´çš„ä¸»è¦è¶¨å‹¢å’Œé©…å‹•å› ç´ 
2. **æ–°èå½±éŸ¿è©•ä¼°**: æ·±åº¦è§£è®€é‡è¦æ–°èå°å¸‚å ´çš„æ½›åœ¨å½±éŸ¿
3. **ç”¢æ¥­è¼ªå‹•åˆ†æ**: åˆ†æè³‡é‡‘æµå‘å’Œç”¢æ¥­è¡¨ç¾
4. **é¢¨éšªèˆ‡æ©Ÿæœƒ**: è­˜åˆ¥ç•¶å‰å¸‚å ´é¢¨éšªå’ŒæŠ•è³‡æ©Ÿæœƒ
5. **å¾Œå¸‚å±•æœ›**: æä¾›æœªä¾†ä¸€é€±çš„å¸‚å ´å±•æœ›

### å ±å‘Šé¢¨æ ¼:
- å°ˆæ¥­ä½†æ˜“æ‡‚
- æ•¸æ“šé©…å‹•,æ´å¯Ÿç‚ºå…ˆ
- çµæ§‹æ¸…æ™°,é‡é»çªå‡º
- é¿å…æ¨¡ç³Šå»ºè­°,æä¾›å…·é«”æ–¹å‘

---

## ğŸ“Š ä»Šæ—¥å¸‚å ´æ•¸æ“š

### å…¨çƒå¸‚å ´æŒ‡æ•¸
```markdown
EOF

    cat >> "${MARKET_PROMPT_FILE}" <<EOF
${indices_data}
\`\`\`

### å¸‚å ´æ–°è (${news_count} å‰‡)
\`\`\`markdown
${news_data}
\`\`\`

---

## ğŸ“„ å ±å‘Šçµæ§‹

è«‹æŒ‰ç…§ä»¥ä¸‹çµæ§‹ç”Ÿæˆå ±å‘Š:

# ğŸ“ˆ å…¨çƒå¸‚å ´åˆ†æ - ${TODAY}

> **å ±å‘Šç”Ÿæˆæ™‚é–“**: $(date +"%Y-%m-%d %H:%M UTC")
> **åˆ†æå¼•æ“**: Market Intelligence System v2.1
> **å ±å‘Šé¡å‹**: å…¨çƒå¸‚å ´æƒ…å ±

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

### å¸‚å ´æ¦‚æ³
[ç”¨ 2-3 æ®µæ–‡å­—ç¸½çµä»Šæ—¥å…¨çƒå¸‚å ´è¡¨ç¾:]
- ä¸»è¦å¸‚å ´è¶¨å‹¢ (ç¾è‚¡ã€äºè‚¡ã€æ­è‚¡)
- é—œéµé©…å‹•å› ç´ 
- å¸‚å ´æƒ…ç·’æŒ‡æ¨™ (VIX)
- é‡è¦äº‹ä»¶æˆ–æ•¸æ“š

### é—œéµæ•¸æ“š

| æŒ‡æ¨™ | æ•¸å€¼ | è®ŠåŒ– | ç‹€æ…‹ |
|------|------|------|------|
| S&P 500 | X,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| Nasdaq | XX,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| VIX | XX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| å°è‚¡åŠ æ¬Š | XX,XXX.XX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |
| é»ƒé‡‘ | \\\$X,XXX | +X.XX% | ğŸŸ¢/ğŸ”´ æè¿° |

### å¸‚å ´æƒ…ç·’è©•ä¼°

| é¡åˆ¥ | è©•åˆ† (1-10) | èªªæ˜ |
|------|-------------|------|
| æ•´é«”å¸‚å ´æƒ…ç·’ | X | ç°¡çŸ­èªªæ˜ |
| ç§‘æŠ€è‚¡æƒ…ç·’ | X | ç°¡çŸ­èªªæ˜ |
| æ³¢å‹•æ€§é¢¨éšª | X | ç°¡çŸ­èªªæ˜ |

---

## ğŸŒ å…¨çƒå¸‚å ´æ·±åº¦åˆ†æ

### ç¾åœ‹å¸‚å ´ ğŸ‡ºğŸ‡¸

**ä¸»è¦æŒ‡æ•¸è¡¨ç¾**

| æŒ‡æ•¸ | æ”¶ç›¤åƒ¹ | æ¼²è·Œå¹… | æŠ€è¡“ç‹€æ…‹ |
|------|--------|--------|----------|
| S&P 500 | X,XXX.XX | +X.XX% | æè¿° |
| Nasdaq | XX,XXX.XX | +X.XX% | æè¿° |
| Dow Jones | XX,XXX.XX | +X.XX% | æè¿° |

**å¸‚å ´åˆ†æ**:
[æ·±å…¥åˆ†æç¾åœ‹å¸‚å ´:]
- ä¸»è¦é©…å‹•å› ç´ 
- ç”¢æ¥­è¼ªå‹•æƒ…æ³
- æŠ€è¡“é¢é—œéµæ°´å¹³
- å¾Œå¸‚å±•æœ›

### äºæ´²å¸‚å ´ ğŸŒ

**ä¸»è¦å¸‚å ´è¡¨ç¾**

| å¸‚å ´ | æŒ‡æ•¸ | æ”¶ç›¤åƒ¹ | æ¼²è·Œå¹… |
|------|------|--------|--------|
| ğŸ‡¹ğŸ‡¼ å°ç£ | åŠ æ¬ŠæŒ‡æ•¸ | XX,XXX.XX | +X.XX% |
| ğŸ‡¯ğŸ‡µ æ—¥æœ¬ | æ—¥ç¶“225 | XX,XXX.XX | +X.XX% |
| ğŸ‡°ğŸ‡· éŸ“åœ‹ | KOSPI | X,XXX.XX | +X.XX% |

**å¸‚å ´åˆ†æ**:
[åˆ†æäºæ´²å¸‚å ´è¶¨å‹¢]

### æ­æ´²å¸‚å ´ ğŸ‡ªğŸ‡º

**å¸‚å ´åˆ†æ**:
[ç°¡è¦åˆ†ææ­æ´²å¸‚å ´]

---

## ğŸ“° é‡è¦æ–°èè§£è®€

[æŒ‰ä¸»é¡Œæˆ–ç”¢æ¥­åˆ†é¡,æ·±å…¥è§£è®€å½±éŸ¿å¸‚å ´çš„é‡è¦æ–°èã€‚æ¯å‰‡æ–°èå¿…é ˆæ¨™è¨»ä¾†æºå’Œç™¼å¸ƒæ™‚é–“:]

### ç§‘æŠ€ç”¢æ¥­

#### ğŸ“Œ æ–°èæ¨™é¡Œ
- **ä¾†æº**: [æ–°èä¾†æº,å¦‚ Yahoo Financeã€Barrons.com ç­‰]
- **ç™¼å¸ƒæ™‚é–“**: [æ™‚é–“]
- **å½±éŸ¿è©•ä¼°**: ğŸŸ¢ æ­£é¢ / ğŸŸ¡ ä¸­æ€§ / ğŸ”´ è² é¢
- **æ·±åº¦åˆ†æ**: [åˆ†ææ–°èå…§å®¹ã€å¸‚å ´å½±éŸ¿ã€æŠ•è³‡å•Ÿç¤º]

### å…¶ä»–ç”¢æ¥­

#### ğŸ“Œ æ–°èæ¨™é¡Œ
- **ä¾†æº**: [æ–°èä¾†æº]
- **ç™¼å¸ƒæ™‚é–“**: [æ™‚é–“]
- **å½±éŸ¿è©•ä¼°**: ğŸŸ¢ æ­£é¢ / ğŸŸ¡ ä¸­æ€§ / ğŸ”´ è² é¢
- **æ·±åº¦åˆ†æ**: [åŒä¸Š]

---

## ğŸ­ ç”¢æ¥­è¼ªå‹•åˆ†æ

### å¼·å‹¢ç”¢æ¥­

| ç”¢æ¥­ | è¡¨ç¾ | é©…å‹•å› ç´  |
|------|------|----------|
| ç”¢æ¥­1 | +X.XX% | ç°¡è¿° |
| ç”¢æ¥­2 | +X.XX% | ç°¡è¿° |

### å¼±å‹¢ç”¢æ¥­

| ç”¢æ¥­ | è¡¨ç¾ | åŸå›  |
|------|------|------|
| ç”¢æ¥­1 | -X.XX% | ç°¡è¿° |

**åˆ†æ**: [æ·±å…¥åˆ†æç”¢æ¥­è¼ªå‹•èƒŒå¾Œçš„é‚è¼¯]

---

## âš ï¸ é¢¨éšªèˆ‡æ©Ÿæœƒ

### å¸‚å ´é¢¨éšª

1. **é¢¨éšª1**: è©³ç´°èªªæ˜
2. **é¢¨éšª2**: è©³ç´°èªªæ˜
3. **é¢¨éšª3**: è©³ç´°èªªæ˜

### æŠ•è³‡æ©Ÿæœƒ

1. **æ©Ÿæœƒ1**: è©³ç´°èªªæ˜
2. **æ©Ÿæœƒ2**: è©³ç´°èªªæ˜

### VIX ææ…ŒæŒ‡æ•¸åˆ†æ

- **ç•¶å‰å€¼**: XX.XX
- **è®ŠåŒ–**: Â±X.XX%
- **è§£è®€**: [åˆ†æå¸‚å ´æƒ…ç·’å’Œæ³¢å‹•æ€§é æœŸ]

---

## ğŸ”® å¾Œå¸‚å±•æœ›

### æœªä¾†ä¸€é€±é—œéµäº‹ä»¶

**ç¶“æ¿Ÿæ•¸æ“š**:
- æ—¥æœŸ: æ•¸æ“šåç¨± - é æœŸå½±éŸ¿
- æ—¥æœŸ: æ•¸æ“šåç¨± - é æœŸå½±éŸ¿

**ä¼æ¥­è²¡å ±**:
- æ—¥æœŸ: å…¬å¸åç¨± - é—œæ³¨é‡é»

**å…¶ä»–é‡è¦äº‹ä»¶**:
- äº‹ä»¶æè¿°

### æƒ…å¢ƒåˆ†æ

#### æ¨‚è§€æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[æ¢ä»¶ã€é æœŸå½±éŸ¿ã€å¸‚å ´åæ‡‰]

#### åŸºæº–æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[æ¢ä»¶ã€é æœŸå½±éŸ¿ã€å¸‚å ´åæ‡‰]

#### æ‚²è§€æƒ…å¢ƒ (æ©Ÿç‡: XX%)
[æ¢ä»¶ã€é æœŸå½±éŸ¿ã€å¸‚å ´åæ‡‰]

---

## ğŸ’¡ æŠ•è³‡ç­–ç•¥å»ºè­°

### çŸ­æœŸè§€é» (1-2é€±)

**å¸‚å ´çœ‹æ³•**: [ç¸½çµ]

**ç­–ç•¥å»ºè­°**:
1. å»ºè­°1
2. å»ºè­°2

### ä¸­æœŸè§€é» (1-3å€‹æœˆ)

**å¸‚å ´çœ‹æ³•**: [ç¸½çµ]

**ç­–ç•¥å»ºè­°**:
1. å»ºè­°1
2. å»ºè­°2

---

## âš ï¸ å…è²¬è²æ˜

æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒ,ä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡æœ‰é¢¨éšª,è«‹æ ¹æ“šè‡ªèº«æƒ…æ³åšå‡ºç¨ç«‹æ±ºç­–ã€‚

---

**åˆ†æå¼•æ“**: Claude (Sonnet 4.5)
**å ±å‘Šç‰ˆæœ¬**: v2.1

---

è«‹ç›´æ¥é–‹å§‹ç”Ÿæˆå®Œæ•´çš„å¸‚å ´åˆ†æå ±å‘Š,å¾æ¨™é¡Œé–‹å§‹,ä¸è¦æœ‰ä»»ä½•å‰ç½®èªªæ˜æˆ–è©¢å•ã€‚
EOF

    echo -e "${GREEN}   âœ… å¸‚å ´åˆ†æ Prompt å·²ç”Ÿæˆ${NC}"
    echo ""
}

# åŸ·è¡Œå¸‚å ´åˆ†æ
run_market_analysis() {
    echo -e "${BLUE}ğŸ§  èª¿ç”¨ Claude é€²è¡Œå¸‚å ´åˆ†æ...${NC}"
    echo -e "${YELLOW}   é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜,è«‹ç¨å€™...${NC}"
    echo ""

    mkdir -p "${REPORTS_DIR}"

    if cat "${MARKET_PROMPT_FILE}" | "${CLAUDE_BIN}" > "${MARKET_ANALYSIS_OUTPUT}" 2>&1; then
        echo -e "${GREEN}   âœ… å¸‚å ´åˆ†æå®Œæˆ!${NC}"
        echo -e "${GREEN}   ğŸ“„ ${MARKET_ANALYSIS_OUTPUT}${NC}"
        echo ""
    else
        echo -e "${RED}   âŒ å¸‚å ´åˆ†æå¤±æ•—${NC}"
        exit 1
    fi
}

###############################################################################
# Step 3: æŒå€‰åˆ†æå ±å‘Šç”Ÿæˆ
###############################################################################

# ç”ŸæˆæŒå€‰åˆ†æ Prompt
generate_holdings_analysis_prompt() {
    echo -e "${BLUE}ğŸ“ ç”ŸæˆæŒå€‰åˆ†æ Prompt...${NC}"

    # è®€å–æŒå€‰åƒ¹æ ¼æ•¸æ“š
    local prices_data
    prices_data=$(<"${PRICES}")

    # è®€å–æŒå€‰é…ç½®æ•¸æ“š
    local holdings_config=""
    if [[ -f "${HOLDINGS_CONFIG}" ]]; then
        holdings_config=$(<"${HOLDINGS_CONFIG}")
    fi

    # è®€å–æŠ•è³‡çµ„åˆç¸¾æ•ˆå¿«ç…§æ•¸æ“š
    local portfolio_summary=""
    if [[ -f "${PORTFOLIO_SUMMARY}" ]]; then
        portfolio_summary=$(<"${PORTFOLIO_SUMMARY}")
    fi

    # è®€å–æŠ•è³‡çµ„åˆå®Œæ•´è³‡è¨Š
    local portfolio_data=""
    if [[ -f "${PORTFOLIO_HOLDINGS}" ]]; then
        portfolio_data=$(<"${PORTFOLIO_HOLDINGS}")
    fi

    # ç”ŸæˆæŒå€‰åˆ†æ Prompt
    cat > "${HOLDINGS_PROMPT_FILE}" <<'EOF'
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æŠ•è³‡çµ„åˆåˆ†æå¸«,æ“…é•·è©•ä¼°æŒå€‰è¡¨ç¾å’Œé¢¨éšªç®¡ç†ã€‚

## ğŸ“‹ åˆ†æä»»å‹™

è«‹æ ¹æ“šä»¥ä¸‹æŠ•è³‡çµ„åˆæ•¸æ“š,ç”Ÿæˆä¸€ä»½**ç°¡æ½”çš„æŒå€‰åˆ†æå ±å‘Š**ã€‚

### æ ¸å¿ƒè¦æ±‚(èšç„¦ä¸‰å¤§é‡é»):
1. **æŒè‚¡ç‹€æ³**: åˆ†ææ¯æª”è‚¡ç¥¨çš„è¡¨ç¾ã€æç›Šã€å€‰ä½
2. **é¸æ“‡æ¬Šç®¡ç†**: è©•ä¼°é¸æ“‡æ¬Šåˆ°æœŸé¢¨éšªå’Œè™•ç†å»ºè­°
3. **ç¸¾æ•ˆè¿½è¹¤**: æ•´é«”ç¸¾æ•ˆè¡¨ç¾å’Œé—œéµæŒ‡æ¨™

### å ±å‘Šé¢¨æ ¼:
- ç°¡æ½”ç²¾ç…‰,é‡é»çªå‡º
- æ•¸æ“šé©…å‹•,å®¢è§€åˆ†æ
- æä¾›å¯æ“ä½œçš„å»ºè­°

---

## ğŸ“Š æŠ•è³‡çµ„åˆæ•¸æ“š

### æŠ•è³‡çµ„åˆå®Œæ•´è³‡è¨Š
```markdown
EOF

    cat >> "${HOLDINGS_PROMPT_FILE}" <<EOF
${portfolio_data}
\`\`\`

### è³‡ç”¢ç¸¾æ•ˆå¿«ç…§
\`\`\`yaml
${portfolio_summary}
\`\`\`

### æŒå€‰é…ç½®è©³æƒ…
\`\`\`yaml
${holdings_config}
\`\`\`

### ä»Šæ—¥æŒå€‰åƒ¹æ ¼
\`\`\`markdown
${prices_data}
\`\`\`

### è§€å¯Ÿæ¸…å–®æ–°è (å¦‚æœæœ‰)
\`\`\`markdown
EOF

    # æ”¶é›†è§€å¯Ÿæ¸…å–®çš„æ–°è
    local watchlist_news=""
    if [[ -f "${HOLDINGS_CONFIG}" ]]; then
        # å¾ holdings.yaml æå–è§€å¯Ÿæ¸…å–®çš„è‚¡ç¥¨ä»£ç¢¼
        local watchlist_symbols
        watchlist_symbols=($(awk '
            /^watchlist:/ { in_watchlist=1; next }
            in_watchlist && /^[^ ]/ { in_watchlist=0 }
            in_watchlist && /symbol:/ {
                gsub(/"/, "", $2);
                print $2
            }
        ' "${HOLDINGS_CONFIG}" 2>/dev/null || true))

        for symbol in "${watchlist_symbols[@]}"; do
            local watchlist_news_file="${NEWS_DIR}/${symbol}-${TODAY}.md"
            if [[ -f "${watchlist_news_file}" ]]; then
                local news_content
                news_content=$(<"${watchlist_news_file}")
                watchlist_news="${watchlist_news}

### ${symbol} è§€å¯Ÿæ¸…å–®æ–°è
${news_content}
"
            fi
        done
    fi

    cat >> "${HOLDINGS_PROMPT_FILE}" <<EOF
${watchlist_news}
\`\`\`

---

## ğŸ“„ å ±å‘Šçµæ§‹

è«‹æŒ‰ç…§ä»¥ä¸‹çµæ§‹ç”Ÿæˆå ±å‘Š:

# ğŸ’¼ æŠ•è³‡çµ„åˆåˆ†æ - ${TODAY}

> **å ±å‘Šç”Ÿæˆæ™‚é–“**: $(date +"%Y-%m-%d %H:%M UTC")
> **åˆ†æå¼•æ“**: Market Intelligence System v2.1
> **å ±å‘Šé¡å‹**: æŒå€‰åˆ†æ

---

## ğŸ“Š çµ„åˆæ¦‚æ³

| é …ç›® | æ•¸å€¼ | ç‹€æ…‹ |
|------|------|------|
| ç¸½è³‡ç”¢æ·¨å€¼ | \\\$XXX,XXX.XX | - |
| è‚¡ç¥¨å¸‚å€¼ | \\\$XXX,XXX.XX (XX.X%) | ğŸŸ¢/ğŸŸ¡/ğŸ”´ |
| ç¾é‡‘é¤˜é¡ | \\\$XX,XXX.XX (XX.X%) | ğŸŸ¢/ğŸŸ¡/ğŸ”´ |
| æœªå¯¦ç¾æç›Š | Â±\\\$XX,XXX (Â±X.X%) | ğŸŸ¢/ğŸ”´ |
| ä»Šæ—¥è®ŠåŒ– | Â±X.XX% | ğŸŸ¢/ğŸ”´ |

**é—œéµæç¤º**: [1-2å¥è©±ç¸½çµä»Šæ—¥é‡é»]

---

## ğŸ¯ é¸æ“‡æ¬Šéƒ¨ä½

[ä¾åˆ°æœŸæ—¥åˆ—å‡ºæ‰€æœ‰é¸æ“‡æ¬Šéƒ¨ä½,åƒ…é¡¯ç¤ºé—œéµè³‡è¨Š:]

| åˆ°æœŸæ—¥ | æ¨™çš„ | é¡å‹ | æ•¸é‡ | è¡Œæ¬Šåƒ¹ | ç•¶å‰åƒ¹ | ç‹€æ…‹ | è™•ç†å»ºè­° |
|--------|------|------|------|--------|--------|------|----------|
| 12/XX | TICKER | Call/Put | -X | \\\$XX.XX | \\\$XX.XX | åƒ¹å…§/åƒ¹å¤– | [ç°¡è¿°å»ºè­°] |

**é‡é»é—œæ³¨**:
- [åˆ—å‡ºéœ€è¦ç«‹å³è™•ç†çš„é¸æ“‡æ¬Šéƒ¨ä½]
- [åˆ—å‡ºé¢¨éšªè¼ƒé«˜çš„éƒ¨ä½]

---

## ğŸ“ˆ æŒè‚¡ç‹€æ³

[åˆ—å‡ºæ‰€æœ‰æŒè‚¡,æŒ‰å€‰ä½å¤§å°æˆ–ä»Šæ—¥è¡¨ç¾æ’åº:]

| è‚¡ç¥¨ | æŒè‚¡ | æˆæœ¬ | ç¾åƒ¹ | æç›Š | å€‰ä½ | ä»Šæ—¥ | é¸æ“‡æ¬Š | å»ºè­° |
|------|------|------|------|------|------|------|--------|------|
| TICKER | XXX | \\\$XX.XX | \\\$XX.XX | Â±XX.X% | X.X% | Â±X.X% | æœ‰/ç„¡ | æŒæœ‰/åŠ ç¢¼/æ¸›ç¢¼ |

**é‡é»é—œæ³¨**:
[é‡å°ä»¥ä¸‹è‚¡ç¥¨é€²è¡Œç°¡è¦åˆ†æ:]
- ä»Šæ—¥æ¼²è·Œå¹… > 3%
- å€‰ä½ > 8%
- æç›Š > Â±15%
- æœ‰ç·Šæ€¥é¸æ“‡æ¬Šåˆ°æœŸ

#### ğŸ“Š TICKER
- **ç‹€æ…‹**: [1-2å¥è©±èªªæ˜ç•¶å‰ç‹€æ…‹]
- **å»ºè­°**: [å…·é«”æ“ä½œå»ºè­°]
- **é¢¨éšª**: [é—œéµé¢¨éšªé»]

[åƒ…åˆ†æéœ€è¦é—œæ³¨çš„é‡é»æŒè‚¡]

---

## ğŸ“Š ç¸¾æ•ˆè¿½è¹¤

### æœ¬æœˆç¸¾æ•ˆï¼ˆæˆªè‡³ä»Šæ—¥ï¼‰

| æŒ‡æ¨™ | æ•¸å€¼ | è©•ä¼° |
|------|------|------|
| æœˆåº¦å ±é…¬ç‡ | Â±X.XX% | ğŸŸ¢/ğŸ”´ |
| vs S&P 500 | Â±X.XX% | ğŸŸ¢/ğŸ”´ |
| æœ€ä½³æŒè‚¡ | TICKER (+XX.X%) | - |
| æœ€å·®æŒè‚¡ | TICKER (-XX.X%) | - |
| å‹ç‡ | XX% | - |

### å¹´åº¦ç¸¾æ•ˆï¼ˆæˆªè‡³ä»Šæ—¥ï¼‰

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| å¹´åº¦å ±é…¬ç‡ | Â±X.XX% |
| vs S&P 500 | Â±X.XX% |

---

## ğŸ‘€ è§€å¯Ÿæ¸…å–®åˆ†æ

[å¦‚æœæœ‰è§€å¯Ÿæ¸…å–®è‚¡ç¥¨ä¸”æœ‰æ–°è,åˆ†æé€™äº›éæŒè‚¡çš„æ¨™çš„:]

### ğŸ“Š è§€å¯Ÿæ¨™çš„æ¦‚æ³

| è‚¡ç¥¨ | ç•¶å‰åƒ¹ | ä»Šæ—¥æ¼²è·Œ | æ–°èæƒ…ç·’ | è©•ä¼° |
|------|--------|----------|---------|------|
| TICKER | \\\$XX.XX | Â±X.XX% | ğŸŸ¢/ğŸŸ¡/ğŸ”´ | ç°¡è¿° |

### é‡é»è§€å¯Ÿæ¨™çš„

[é‡å°æœ‰é‡è¦æ–°èæˆ–åƒ¹æ ¼ç•°å‹•çš„è§€å¯Ÿæ¨™çš„é€²è¡Œåˆ†æ:]

#### ğŸ“Œ TICKER
- **æœ€æ–°å‹•æ…‹**: [ç¸½çµæœ€æ–°æ–°è]
- **åƒ¹æ ¼è¡¨ç¾**: [åƒ¹æ ¼èµ°å‹¢åˆ†æ]
- **æŠ•è³‡åƒ¹å€¼**: [æ˜¯å¦å€¼å¾—è€ƒæ…®å»ºå€‰]
- **é¢¨éšªå› ç´ **: [ä¸»è¦é¢¨éšªé»]

[å¦‚æœæ²’æœ‰è§€å¯Ÿæ¸…å–®æˆ–æ²’æœ‰ç›¸é—œæ–°è,å‰‡çœç•¥æ­¤å€å¡Š]

---

## âš ï¸ å…è²¬è²æ˜

æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒ,ä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡æœ‰é¢¨éšª,è«‹æ ¹æ“šè‡ªèº«æƒ…æ³åšå‡ºç¨ç«‹æ±ºç­–ã€‚

---

**åˆ†æå¼•æ“**: Claude (Sonnet 4.5)
**å ±å‘Šç‰ˆæœ¬**: v2.1

---

è«‹ç›´æ¥é–‹å§‹ç”Ÿæˆå®Œæ•´çš„æŒå€‰åˆ†æå ±å‘Š,å¾æ¨™é¡Œé–‹å§‹,ä¸è¦æœ‰ä»»ä½•å‰ç½®èªªæ˜æˆ–è©¢å•ã€‚
EOF

    echo -e "${GREEN}   âœ… æŒå€‰åˆ†æ Prompt å·²ç”Ÿæˆ${NC}"
    echo ""
}

# åŸ·è¡ŒæŒå€‰åˆ†æ
run_holdings_analysis() {
    echo -e "${BLUE}ğŸ§  èª¿ç”¨ Claude é€²è¡ŒæŒå€‰åˆ†æ...${NC}"
    echo -e "${YELLOW}   é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜,è«‹ç¨å€™...${NC}"
    echo ""

    mkdir -p "${REPORTS_DIR}"

    if cat "${HOLDINGS_PROMPT_FILE}" | "${CLAUDE_BIN}" > "${HOLDINGS_ANALYSIS_OUTPUT}" 2>&1; then
        echo -e "${GREEN}   âœ… æŒå€‰åˆ†æå®Œæˆ!${NC}"
        echo -e "${GREEN}   ğŸ“„ ${HOLDINGS_ANALYSIS_OUTPUT}${NC}"
        echo ""
    else
        echo -e "${RED}   âŒ æŒå€‰åˆ†æå¤±æ•—${NC}"
        exit 1
    fi
}

###############################################################################
# çµæœå±•ç¤º
###############################################################################

# é¡¯ç¤ºæ‰€æœ‰ç”Ÿæˆçš„å ±å‘Š
show_results() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${GREEN}âœ… æ‰€æœ‰åˆ†æå ±å‘Šå·²ç”Ÿæˆå®Œç•¢!${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""

    echo -e "${YELLOW}ğŸ“Š ç”Ÿæˆå ±å‘Šæ‘˜è¦:${NC}"
    echo ""

    echo -e "${GREEN}ğŸ“ˆ å¸‚å ´åˆ†æå ±å‘Š:${NC}"
    echo -e "${GREEN}   ${MARKET_ANALYSIS_OUTPUT}${NC}"
    echo ""

    # åˆ—å‡ºæ‰€æœ‰å€‹è‚¡åˆ†ææª”æ¡ˆ
    local stock_files
    stock_files=($(find "${REPORTS_DIR}" -name "stock-*-${TODAY}-${TIME_SUFFIX}.md" 2>/dev/null || true))
    if [[ ${#stock_files[@]} -gt 0 ]]; then
        echo -e "${GREEN}ğŸ“Š å€‹è‚¡åˆ†æå ±å‘Š (${#stock_files[@]} æª”):${NC}"
        for stock_file in "${stock_files[@]}"; do
            local filename=$(basename "${stock_file}")
            echo -e "${GREEN}   ${filename}${NC}"
        done
        echo ""
    fi

    echo -e "${GREEN}ğŸ’¼ æŒå€‰åˆ†æå ±å‘Š:${NC}"
    echo -e "${GREEN}   ${HOLDINGS_ANALYSIS_OUTPUT}${NC}"
    echo ""

    echo -e "${BLUE}------------------------------------------------------------${NC}"
    echo -e "${YELLOW}ğŸ“‹ å¿«é€ŸæŸ¥çœ‹å ±å‘Š:${NC}"
    echo ""
    echo -e "${GREEN}   # å¸‚å ´åˆ†æ${NC}"
    echo -e "   cat ${MARKET_ANALYSIS_OUTPUT}"
    echo ""
    echo -e "${GREEN}   # æŒå€‰åˆ†æ${NC}"
    echo -e "   cat ${HOLDINGS_ANALYSIS_OUTPUT}"
    echo ""
    if [[ ${#stock_files[@]} -gt 0 ]]; then
        echo -e "${GREEN}   # å€‹è‚¡åˆ†æ${NC}"
        echo -e "   ls ${REPORTS_DIR}/stock-*-${TODAY}-${TIME_SUFFIX}.md"
        echo ""
    fi
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    echo ""
}

###############################################################################
# ä¸»ç¨‹å¼
###############################################################################

main() {
    # é¡¯ç¤ºæ¨™é¡Œ
    print_header

    # ç³»çµ±æª¢æŸ¥
    check_dependencies
    check_data_files

    # Step 1: å¸‚å ´åˆ†æ
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}ğŸ“Š Step 1/3: å¸‚å ´åˆ†æ - äº†è§£å…¨çƒå¸‚å ´ç’°å¢ƒ${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    generate_market_analysis_prompt
    run_market_analysis

    # Step 2: å€‹è‚¡åˆ†æ
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}ğŸ“ˆ Step 2/3: å€‹è‚¡åˆ†æ - æ·±å…¥åˆ†æå€‹åˆ¥è‚¡ç¥¨${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    generate_stock_analysis_files

    # Step 3: æŒå€‰åˆ†æ
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}ğŸ’¼ Step 3/3: æŒå€‰åˆ†æ - è©•ä¼°æŠ•è³‡çµ„åˆè¡¨ç¾${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    generate_holdings_analysis_prompt
    run_holdings_analysis

    # é¡¯ç¤ºçµæœ
    show_results

    # æ¸…ç†
    cleanup

    # å®Œæˆ
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ… æ¯æ—¥åˆ†æå®Œæˆ! å…±ç”Ÿæˆ 3 é¡å ±å‘Š${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

###############################################################################
# åŸ·è¡Œä¸»ç¨‹å¼
###############################################################################

main "$@"
