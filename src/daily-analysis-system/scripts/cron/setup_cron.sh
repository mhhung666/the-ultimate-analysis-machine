#!/usr/bin/env bash
###############################################################################
# Market Intelligence System - Cron Job Setup for macOS
#
# è¨­å®šå®šæ™‚ä»»å‹™:
# - æ—©ä¸Š 08:00 åŸ·è¡Œ (ç¾Žåœ‹æ”¶ç›¤å¾Œçš„æ–°èž)
# - æ™šä¸Š 20:00 åŸ·è¡Œ (äºžæ´²æ”¶ç›¤å¾Œçš„æ–°èž)
#
# ä½¿ç”¨æ–¹å¼:
#   chmod +x setup_cron.sh
#   ./setup_cron.sh
###############################################################################

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ç²å–å°ˆæ¡ˆæ ¹ç›®éŒ„çš„çµ•å°è·¯å¾‘
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="/tmp/market-intelligence-system.log"

echo -e "${BLUE}============================================================${NC}"
echo -e "${BLUE}ðŸ“… Market Intelligence System - Cron Job è¨­å®š${NC}"
echo -e "${BLUE}============================================================${NC}"
echo ""

echo -e "${GREEN}å°ˆæ¡ˆè·¯å¾‘: ${PROJECT_ROOT}${NC}"
echo -e "${GREEN}æ—¥èªŒæª”æ¡ˆ: ${LOG_FILE}${NC}"
echo ""

# æª¢æŸ¥ä¾è³´
echo -e "${BLUE}ðŸ” æª¢æŸ¥ä¾è³´...${NC}"

# æª¢æŸ¥ Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}âŒ éŒ¯èª¤: æœªå®‰è£ Python 3${NC}"
    exit 1
fi
echo -e "${GREEN}   âœ… Python 3: $(python3 --version)${NC}"

# æª¢æŸ¥ make
if ! command -v make &> /dev/null; then
    echo -e "${RED}âŒ éŒ¯èª¤: æœªå®‰è£ make${NC}"
    exit 1
fi
echo -e "${GREEN}   âœ… Make: $(make --version | head -1)${NC}"

# æª¢æŸ¥ Claude CLI
if ! command -v claude &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  è­¦å‘Š: æœªå®‰è£ Claude CLI${NC}"
    echo -e "${YELLOW}   è«‹åŸ·è¡Œ: npm install -g @anthropic-ai/claude-cli${NC}"
    echo -e "${YELLOW}   ç„¶å¾ŒåŸ·è¡Œ: claude login${NC}"
else
    echo -e "${GREEN}   âœ… Claude CLI å·²å®‰è£${NC}"
fi

echo ""

# å‰µå»º cron ä»»å‹™è…³æœ¬
echo -e "${BLUE}ðŸ“ å‰µå»º cron åŸ·è¡Œè…³æœ¬...${NC}"

CRON_SCRIPT="${PROJECT_ROOT}/run_daily_cron.sh"

cat > "${CRON_SCRIPT}" <<'CRON_EOF'
#!/usr/bin/env bash
###############################################################################
# Cron Job Execution Script
# ç”± cron èª¿ç”¨çš„å¯¦éš›åŸ·è¡Œè…³æœ¬
###############################################################################

set -e

# æ—¥æœŸå’Œæ™‚é–“
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
TODAY=$(date +"%Y-%m-%d")

# è·¯å¾‘è¨­å®š
PROJECT_ROOT="__PROJECT_ROOT__"
LOG_FILE="__LOG_FILE__"

# ç’°å¢ƒè®Šæ•¸ (macOS cron ç’°å¢ƒè®Šæ•¸å—é™,éœ€è¦æ˜Žç¢ºè¨­å®š PATH)
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:$HOME/.local/bin:$HOME/.nvm/versions/node/*/bin"
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# å¯«å…¥æ—¥èªŒçš„å‡½æ•¸
log() {
    echo "[${TIMESTAMP}] $1" | tee -a "${LOG_FILE}"
}

# é–‹å§‹åŸ·è¡Œ
log "============================================================"
log "ðŸ“Š Market Intelligence System - Daily Analysis Started"
log "============================================================"

# åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„
cd "${PROJECT_ROOT}" || {
    log "âŒ éŒ¯èª¤: ç„¡æ³•åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„ ${PROJECT_ROOT}"
    exit 1
}

log "ðŸ“‚ å·¥ä½œç›®éŒ„: $(pwd)"

# åŸ·è¡Œå®Œæ•´çš„æ¯æ—¥åˆ†æžå·¥ä½œæµç¨‹
log "ðŸš€ é–‹å§‹åŸ·è¡Œ make daily (fetch-all + analyze-daily)..."

if make daily >> "${LOG_FILE}" 2>&1; then
    log "âœ… æ¯æ—¥åˆ†æžå®Œæˆ!"

    # é¡¯ç¤ºç”Ÿæˆçš„å ±å‘Šè·¯å¾‘
    MARKET_REPORT="${PROJECT_ROOT}/reports/markdown/market-analysis-${TODAY}.md"
    HOLDINGS_REPORT="${PROJECT_ROOT}/reports/markdown/holdings-analysis-${TODAY}.md"

    if [[ -f "${MARKET_REPORT}" ]]; then
        log "ðŸ“ˆ å¸‚å ´åˆ†æžå ±å‘Š: ${MARKET_REPORT}"
    fi

    if [[ -f "${HOLDINGS_REPORT}" ]]; then
        log "ðŸ’¼ æŒå€‰åˆ†æžå ±å‘Š: ${HOLDINGS_REPORT}"
    fi

    log "âœ… æ‰€æœ‰ä»»å‹™åŸ·è¡ŒæˆåŠŸ!"
else
    log "âŒ åŸ·è¡Œå¤±æ•—,è«‹æª¢æŸ¥æ—¥èªŒ: ${LOG_FILE}"
    exit 1
fi

# Git æäº¤å ±å‘Š
log "ðŸ“ é–‹å§‹ Git æäº¤..."

# æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
if git -C "${PROJECT_ROOT}" status --porcelain | grep -q "reports/markdown"; then
    log "   ç™¼ç¾ markdown å ±å‘Šè®Šæ›´,æº–å‚™æäº¤..."

    # æ·»åŠ å ±å‘Šæª”æ¡ˆ
    git -C "${PROJECT_ROOT}" add reports/markdown/*.md >> "${LOG_FILE}" 2>&1 || true

    # æäº¤è®Šæ›´
    if git -C "${PROJECT_ROOT}" commit -m "feat(daily): Update analysis reports for ${TODAY}

ðŸ“Š è‡ªå‹•ç”Ÿæˆçš„æ¯æ—¥å¸‚å ´åˆ†æžå ±å‘Š

- å¸‚å ´åˆ†æžå ±å‘Š: market-analysis-${TODAY}.md
- æŒå€‰åˆ†æžå ±å‘Š: holdings-analysis-${TODAY}.md

ðŸ¤– Generated by Market Intelligence System (Cron Job)" >> "${LOG_FILE}" 2>&1; then
        log "âœ… Git æäº¤æˆåŠŸ!"

        # æŽ¨é€åˆ° remote (å¯é¸,å¦‚æžœä½ å¸Œæœ›è‡ªå‹•æŽ¨é€)
        # æ³¨æ„: éœ€è¦å…ˆè¨­å®š SSH key æˆ– credential helper
        if git -C "${PROJECT_ROOT}" push origin main >> "${LOG_FILE}" 2>&1; then
            log "âœ… Git æŽ¨é€æˆåŠŸ!"
        else
            log "âš ï¸  Git æŽ¨é€å¤±æ•— (å¯èƒ½éœ€è¦æ‰‹å‹•æŽ¨é€æˆ–è¨­å®šèªè­‰)"
        fi
    else
        log "âš ï¸  Git æäº¤å¤±æ•—æˆ–ç„¡å…§å®¹è®Šæ›´"
    fi
else
    log "   â„¹ï¸  æ²’æœ‰ markdown å ±å‘Šè®Šæ›´,è·³éŽ Git æäº¤"
fi

log "============================================================"
log "ðŸ“Š Market Intelligence System - Daily Analysis Completed"
log "============================================================"
CRON_EOF

# æ›¿æ›è…³æœ¬ä¸­çš„è®Šæ•¸
sed -i '' "s|__PROJECT_ROOT__|${PROJECT_ROOT}|g" "${CRON_SCRIPT}"
sed -i '' "s|__LOG_FILE__|${LOG_FILE}|g" "${CRON_SCRIPT}"

# è¨­å®šåŸ·è¡Œæ¬Šé™
chmod +x "${CRON_SCRIPT}"

echo -e "${GREEN}   âœ… Cron åŸ·è¡Œè…³æœ¬å·²å‰µå»º: ${CRON_SCRIPT}${NC}"
echo ""

# å‚™ä»½ç¾æœ‰çš„ crontab
echo -e "${BLUE}ðŸ“‹ å‚™ä»½ç¾æœ‰ crontab...${NC}"
BACKUP_FILE="${PROJECT_ROOT}/crontab.backup.$(date +%Y%m%d_%H%M%S)"
crontab -l > "${BACKUP_FILE}" 2>/dev/null || echo "# No existing crontab" > "${BACKUP_FILE}"
echo -e "${GREEN}   âœ… å‚™ä»½å·²ä¿å­˜: ${BACKUP_FILE}${NC}"
echo ""

# ç”Ÿæˆæ–°çš„ crontab å…§å®¹
echo -e "${BLUE}ðŸ“ ç”Ÿæˆæ–°çš„ crontab è¨­å®š...${NC}"
TEMP_CRONTAB="/tmp/mis_crontab_$$"

# è¤‡è£½ç¾æœ‰ crontab (æŽ’é™¤èˆŠçš„ MIS ä»»å‹™)
crontab -l 2>/dev/null | grep -v "market-intelligence-system" > "${TEMP_CRONTAB}" || true

# æ·»åŠ æ–°çš„ cron ä»»å‹™
cat >> "${TEMP_CRONTAB}" <<EOF

# ============================================================
# Market Intelligence System - è‡ªå‹•åŒ–å¸‚å ´åˆ†æž
# ============================================================
# æ—©ä¸Š 08:00 åŸ·è¡Œ (ç¾Žåœ‹æ”¶ç›¤å¾Œçš„æ–°èž)
0 8 * * * ${CRON_SCRIPT}

# æ™šä¸Š 20:00 åŸ·è¡Œ (äºžæ´²æ”¶ç›¤å¾Œçš„æ–°èž)
0 20 * * * ${CRON_SCRIPT}
# ============================================================
EOF

echo ""
echo -e "${YELLOW}å³å°‡å®‰è£ä»¥ä¸‹ cron ä»»å‹™:${NC}"
echo -e "${YELLOW}------------------------------------------------------------${NC}"
cat "${TEMP_CRONTAB}"
echo -e "${YELLOW}------------------------------------------------------------${NC}"
echo ""

# è©¢å•ç¢ºèª
read -p "æ˜¯å¦å®‰è£é€™äº› cron ä»»å‹™? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    crontab "${TEMP_CRONTAB}"
    echo -e "${GREEN}âœ… Cron ä»»å‹™å·²å®‰è£!${NC}"
    echo ""

    echo -e "${BLUE}ðŸ“‹ ç•¶å‰ crontab è¨­å®š:${NC}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    crontab -l
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    echo ""

    echo -e "${GREEN}ðŸŽ‰ è¨­å®šå®Œæˆ!${NC}"
    echo ""
    echo -e "${BLUE}åŸ·è¡Œæ™‚é–“:${NC}"
    echo -e "  â€¢ æ¯å¤©æ—©ä¸Š 08:00 (ç¾Žåœ‹æ”¶ç›¤å¾Œ)"
    echo -e "  â€¢ æ¯å¤©æ™šä¸Š 20:00 (äºžæ´²æ”¶ç›¤å¾Œ)"
    echo ""
    echo -e "${BLUE}æ—¥èªŒä½ç½®:${NC}"
    echo -e "  ${LOG_FILE}"
    echo ""
    echo -e "${BLUE}æŸ¥çœ‹æ—¥èªŒ:${NC}"
    echo -e "  tail -f ${LOG_FILE}"
    echo ""
    echo -e "${BLUE}æ‰‹å‹•æ¸¬è©¦åŸ·è¡Œ:${NC}"
    echo -e "  ${CRON_SCRIPT}"
    echo ""
    echo -e "${BLUE}ç§»é™¤ cron ä»»å‹™:${NC}"
    echo -e "  crontab -e  # ç„¶å¾Œæ‰‹å‹•åˆªé™¤ Market Intelligence System ç›¸é—œè¡Œ"
    echo ""
    echo -e "${BLUE}é‚„åŽŸå‚™ä»½:${NC}"
    echo -e "  crontab ${BACKUP_FILE}"
    echo ""
else
    echo -e "${YELLOW}âŒ å·²å–æ¶ˆå®‰è£${NC}"
    rm -f "${TEMP_CRONTAB}"
    exit 0
fi

# æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
rm -f "${TEMP_CRONTAB}"

echo -e "${GREEN}âœ… æ‰€æœ‰è¨­å®šå®Œæˆ!${NC}"
