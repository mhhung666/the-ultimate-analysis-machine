#!/usr/bin/env bash
###############################################################################
# Cron Job Execution Script
# ç”± cron èª¿ç”¨çš„å¯¦éš›åŸ·è¡Œè…³æœ¬
###############################################################################

set -e

# æ—¥æœŸå’Œæ™‚é–“
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
TODAY=$(date +"%Y-%m-%d")

# è·¯å¾‘è¨­å®š
PROJECT_ROOT="/Users/mhhung/Development/MH/market-intelligence-system"
LOG_FILE="/tmp/market-intelligence-system.log"

# ç’°å¢ƒè®Šæ•¸ (macOS cron ç’°å¢ƒè®Šæ•¸å—é™,éœ€è¦æ˜ç¢ºè¨­å®š PATH)
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:$HOME/.local/bin:$HOME/.nvm/versions/node/*/bin"
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# å¯«å…¥æ—¥èªŒçš„å‡½æ•¸
log() {
    echo "[${TIMESTAMP}] $1" | tee -a "${LOG_FILE}"
}

# é–‹å§‹åŸ·è¡Œ
log "============================================================"
log "ğŸ“Š Market Intelligence System - Daily Analysis Started"
log "============================================================"

# åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„
cd "${PROJECT_ROOT}" || {
    log "âŒ éŒ¯èª¤: ç„¡æ³•åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„ ${PROJECT_ROOT}"
    exit 1
}

log "ğŸ“‚ å·¥ä½œç›®éŒ„: $(pwd)"

# åŸ·è¡Œå®Œæ•´çš„æ¯æ—¥åˆ†æå·¥ä½œæµç¨‹
log "ğŸš€ é–‹å§‹åŸ·è¡Œ make daily (fetch-all + analyze-daily)..."

if make daily >> "${LOG_FILE}" 2>&1; then
    log "âœ… æ¯æ—¥åˆ†æå®Œæˆ!"

    # é¡¯ç¤ºç”Ÿæˆçš„å ±å‘Šè·¯å¾‘
    MARKET_REPORT="${PROJECT_ROOT}/reports/markdown/market-analysis-${TODAY}.md"
    HOLDINGS_REPORT="${PROJECT_ROOT}/reports/markdown/holdings-analysis-${TODAY}.md"

    if [[ -f "${MARKET_REPORT}" ]]; then
        log "ğŸ“ˆ å¸‚å ´åˆ†æå ±å‘Š: ${MARKET_REPORT}"
    fi

    if [[ -f "${HOLDINGS_REPORT}" ]]; then
        log "ğŸ’¼ æŒå€‰åˆ†æå ±å‘Š: ${HOLDINGS_REPORT}"
    fi

    log "âœ… æ‰€æœ‰ä»»å‹™åŸ·è¡ŒæˆåŠŸ!"
else
    log "âŒ åŸ·è¡Œå¤±æ•—,è«‹æª¢æŸ¥æ—¥èªŒ: ${LOG_FILE}"
    exit 1
fi

# Git æäº¤å ±å‘Š
log "ğŸ“ é–‹å§‹ Git æäº¤..."

# æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
if git -C "${PROJECT_ROOT}" status --porcelain | grep -q "reports/markdown"; then
    log "   ç™¼ç¾ markdown å ±å‘Šè®Šæ›´,æº–å‚™æäº¤..."

    # æ·»åŠ å ±å‘Šæª”æ¡ˆ
    git -C "${PROJECT_ROOT}" add reports/markdown/*.md >> "${LOG_FILE}" 2>&1 || true

    # æäº¤è®Šæ›´
    if git -C "${PROJECT_ROOT}" commit -m "feat(daily): Update analysis reports for ${TODAY}

ğŸ“Š è‡ªå‹•ç”Ÿæˆçš„æ¯æ—¥å¸‚å ´åˆ†æå ±å‘Š

- å¸‚å ´åˆ†æå ±å‘Š: market-analysis-${TODAY}.md
- æŒå€‰åˆ†æå ±å‘Š: holdings-analysis-${TODAY}.md

ğŸ¤– Generated by Market Intelligence System (Cron Job)" >> "${LOG_FILE}" 2>&1; then
        log "âœ… Git æäº¤æˆåŠŸ!"

        # æ¨é€åˆ° remote (å¯é¸,å¦‚æœä½ å¸Œæœ›è‡ªå‹•æ¨é€)
        # æ³¨æ„: éœ€è¦å…ˆè¨­å®š SSH key æˆ– credential helper
        if git -C "${PROJECT_ROOT}" push origin main >> "${LOG_FILE}" 2>&1; then
            log "âœ… Git æ¨é€æˆåŠŸ!"
        else
            log "âš ï¸  Git æ¨é€å¤±æ•— (å¯èƒ½éœ€è¦æ‰‹å‹•æ¨é€æˆ–è¨­å®šèªè­‰)"
        fi
    else
        log "âš ï¸  Git æäº¤å¤±æ•—æˆ–ç„¡å…§å®¹è®Šæ›´"
    fi
else
    log "   â„¹ï¸  æ²’æœ‰ markdown å ±å‘Šè®Šæ›´,è·³é Git æäº¤"
fi

log "============================================================"
log "ğŸ“Š Market Intelligence System - Daily Analysis Completed"
log "============================================================"
